# HTTP 캐싱

캐싱이란 이전에 가져온 리소스를 로컬에 저장하고 클라이언트가 리소스를 요청할 때 해당 리소스를 응답하는 기술이다. 적은 비용, 성능향상의 이점이 있다.

## 캐시의 종류

![shared-local(private)-cache](https://mdn.mozillademos.org/files/13777/HTTPCachtType.png)

### Private browser caches(사설 브라우저 캐시)

- 단일 사용자

- 브라우저 캐시가 사용자에 의해 HTTP를 통해 다운로드된 모든 문서들을 가지고 있다.

- 서버에 대한 추가적인 요청 없이 뒤로 가기, 앞으로 가기, 저장, 소스로 보기 등을 위해 방문했던 문서들을 만드는 데 사용된다.

  

### Shared proxy caches(공유 프록시 캐시)

- 여러명의 사용자가 재사용하는 응답을 저장한다.
- 예) ISP나 회사에서 웹프록시를 설치해 조회가 많이 되는 리소스들은 몇 번이고 재사용할 수있도록 만든다.



### 그외

- 게이트웨이 캐시
- CDN
- 리버스 록시 캐시
- 로드 밸런서



## 캐싱 동작의 대상

- 주로 `GET`에 대한 응답을 캐싱한다.
- 일차 캐시키
  - 요청 메서드
  - 대상 URI
- 캐싱 엔트리 폼
  - 요청된 결과: HTML 문서, 이미지, 파일과 같은 리소스를 포함하는 GET 요청에 대한 200(OK) **응답**
  - 301 응답: 영구적인 이동 
  - 404: 페이지 찾을 수 없음
  - 206: 부분적인 컨텐츠 응답 
  - 기타 GET 외 응답(캐시 키로 사용하기에 적절한 무언가가 정의되었을 때)

> URI(Uniform Resource Identifier, URI): 통합 자원 식별자로, 인터넷 에 있는 자원을 나타내는 유일한 주소이다. URI의 하위개념으로 URL, URN이 있다.


## 캐싱 제어

### Cach-control 헤더

- `no-store`: 응답을 캐시할 수 없으며 매 요청마다 전체를 가져온다.

- `no-cache`: 캐시를 사용하기 전 서버에 검증 요청을 보낸다. 

- `private`: 공유 캐시에 저장해도 된다는 뜻이다. HTTP 검증을 가지고 있는 페이지나 원래 캐시가 허용되지 않는 응답 상태 코드에도 사용할 수 있다.
- `Cache-Control : public`:  단일 사용자를 위한 응답이기 때문에 공유 캐시에 의해 저장되어서는 안 된다는 명령이다.

#### Expiration

- `Cache-Control: max-age=<seconds>`
- 리소스가 신선하다고 간주될 최대 시간(초단위)을 지정하는 명령어

캐시는 리소스를 로컬에(혹은 웹프록시에) 저장해 클라이언트가 서버에 리소스를 요청할 때마다 다운로드 하지 않고 캐시에 있는 리소스를 바로바로 보내기 때문에 빠르게 웹페이지가 로드된다(성능이 향상된다). 그러나 여기서는 신선도(Freshness)의 문제가 있다. 서버에서 리소스를 수정했는데도 사용자가 이미 가지고 있는 outdated된 리소스를 가져온다면 수정이 반영되지 않을 것이다. 그렇다면 성능을 챙기면서 어떻게 적정 수준의 신선도를 유지할 수 있을까? 이 방법 중 하나가 `max-age`이다.`max-age`는 말하자면.. 이 지시어를 통해 '언제까지 리소스가 신선하다고 간주할 것인지'를 직접 지정할 수 있다. 

#### Validation

- `Cache-Control: must-revalidate`
- 신선하지 않은 리소스를 사용하기 전에 상태를 검증한다. (만료되었는지 등)

### Pragma header

HTTP/1.1의 Cache-Control 헤더가 생기기 전에 HTTP/1.0에서 대용 헤더로 사용되었다.



## Freshness(신선도)

- cache eviction(캐시 추출): 저장소는 한정되어 있으니 캐시도 주기적으로 제거된다.
- 서버에서 리소스를 업데이트한다면? 리소스 만료 시점에 대해 통신해야 한다. 이 만료시점 이전까지는 리소스가 신선하다고 간주된다.
- 그러나 신선하지 않은 리소스가 바로 추출되거나 무시되는 것은 아니다. 캐시가 캐시가 신선하지 않은 리소스에 대한 요청을 받으면해당 리소스가 서버의 리소스와 차이가 있는지 확인하기 위해 `If-None-Match` 요청을 서버에 보낸다.
- 서버는 이 요청을 받고 서버의 리소스가 수정이 되었는지 확인하고 수정되지 않았으면 해당 리소스 전송 없이 `304`(Not Modified)라고 응답한다.

![http-freshness](https://mdn.mozillademos.org/files/13771/HTTPStaleness.png)

- 신선도 lifetime 계산하기

  ![http-freshness-lifetime](https://user-images.githubusercontent.com/50407047/90239864-3628e600-de63-11ea-97dc-e645663e19e1.jpg)

- 만료시간 = responseTime + freshnessLifetime - currentAge



## 활성화된(Revved) 리소스

리소스 중 자바스크립트와 CSS파일과 같이 변경이 드물지만 변경될 때 빠르게 반영되어야 하는 리소스가 있다. 이럴 경우 드물게 변경되는 파일의 URL에 버전 번호를 추가하고, 이렇게 번호가 추가된 리소스는 만료일을 길게 잡는다. 단점은 새로운 버전이 반영되기 위해서는 연결된 모든 리소스가 함께 영향을 받는다는 것이다. 



  ## 유효함

### 활성화된 리소스



## 캐시 검증

### 강한 검증

- `Etag`: 강한 



###





## 상황에 따른 응답







### Cache Control: maxAge

last-modified : 언제 수정되었는지 웹서버가 웹브라우저한테 알려줌

5초가 지나면 웹브라우저가 웹서버한테 "내가 갖고 있는 ~파일은 이 시간에 마지막으로 (last modified) 수정된 파일이야. 이후로 서버쪽에서 저 파일이 수정된 적이 있어? 있다면 전송해줘, 없다면 없다는 말만 해. 전송은 하지 말고."

"너가 갖고 있는 파일과 내가 갖고 잇는 파일의 마지막으로 수정 시간이 같으니까 수정된 게 없어. "

컨텐츠 자체는 전송하지 않고, 헤더만 주고받고 있다.

만약 수정 사항이 있다면 200 응답과 함께 리소스 전달 

=> 적당히 신선도 있게, 적당히 성능도 챙길 수 있음

요청

Cache Contol: no-cache

- 캐시를 저장하지 않는다는 의미가 아니라 maxAge:0 과 같음. 캐시가 유효한지를 항상 확인



ETag

- Last-Modified: 초까지만은 부정확함. 엄청 빨리 동작하기 때문에
- ETag: b0f-~: 이걸 캐시로서 저장. 
- 이 두개의 값을 주면( 서버가). 
- if modified since, if none match:둘중에 하나라도 값이 다르다면 파일을 보낸다. 조건에 따라서 다르게 동작하는 캐싱 시스템 



결정틀

- 리소스 다시 쓰리거니?
- 유효성 검사: 로컬에 가지고 있는거하고 서버 파일이 다른
- 브라우저 --> Caching Server < - > WebServer
  - 사용자에게 전달해야 하는 데이터가 보안을 요구하고 중간에 저장을 하면 안된다면 Private 을 주면 캐싱 서버가 저장하지 않음. Public 으로 주면 캐싱서버가 저장해서 속도를 향상시켜준다 (특히 거리가 멀 때 서버가 미국이고 브라우저가 한국일 때 사용한다.)

- 캐시의 수명 정할 수 있나?max-age..



- 성능을 향상시키고 귀한 인터넷 자원을 아낄 수 있는 핵심 기술 

- 캐싱을 테스팅할 수 있는 여러 도구가 있음 (개발자 도구, 서비스 등)
- offline application
- prograssive web application

- 네트워크가 끊겨도 할 수 있는 웹사이트? 그러나 캐시는 
  - application cache : 인터넷이 끊겨도 웹을 동작하게 할 수 있음 (마치 앱처럼)
  - 웹브라우저 측에서 동작하는 캐싱, 서버 측에서 동작하는 서버 (캐싱서버)
    - 캐시 데이터를 하드디스크같은 저장장치가 아니라 메모리에 저장해서 같은 페이지에 있으면 메모리에 있는 걸 가져옴 - 고속으로 컨텐츠 제공 -> 웹서버의 부담을 획기적으로 줄이고 빠르게.
    - 캐싱서버를 전세계에 놓으면? 네트워크 속도 죽임
    - 컨텐츠를 배달해주는 네트워크, CDN이라고도 한다. (content delivery network)
  - 